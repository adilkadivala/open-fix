generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// user
model User {
  id        String   @id @default(uuid())
  githubId  String   @unique
  name      String?
  email     String?  @unique
  image     String?
  createdAt DateTime @default(now())

  projects  Project[]
  agentRuns AgentRun[]
}

// projects
model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  repoUrl     String
  repoOwner   String
  repoName    String
  createdAt   DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  issues    Issue[]
  agentRuns AgentRun[]
}

// repo issues
model Issue {
  id            String  @id @default(cuid())
  githubIssueId Int?    @unique
  title         String
  body          String?
  state         String
  labels        Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  agentRuns AgentRun[]
}

// agents
model AgentRun {
  id      String @id @default(cuid())
  status  String // pending | running | success | failed
  runType String // fix_issue | analyze_repo | summarize | etc.

  issueId String?
  issue   Issue?  @relation(fields: [issueId], references: [id])

  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  triggeredById String?
  triggeredBy   User?   @relation(fields: [triggeredById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // HOST-specific relations
  kestraRun   KestraRun?
  clineRun    ClineRun?
  togetherRun TogetherRun?
  oumiRun     OumiRun?
}

// kestra
model KestraRun {
  id         String  @id @default(cuid())
  flowId     String? // kestra flow id
  flowStatus String? // success | failed | running
  logs       Json? // raw execution logs
  summary    String? // kestra summarization output

  createdAt DateTime @default(now())

  agentRunId String   @unique
  agentRun   AgentRun @relation(fields: [agentRunId], references: [id])
}

// cline
model ClineRun {
  id           String  @id @default(cuid())
  plan         Json? // step-by-step plan generated by cline
  patch        String? // code diff
  repoSnapshot Json? // parsed repo structure
  output       Json? // cline final output

  createdAt DateTime @default(now())

  agentRunId String   @unique
  agentRun   AgentRun @relation(fields: [agentRunId], references: [id])
}

// together
model TogetherRun {
  id         String  @id @default(cuid())
  model      String?
  prompt     String?
  response   String?
  tokensUsed Int?
  reasoning  Json? // chain-of-thought summary or reasoning graph

  createdAt DateTime @default(now())

  agentRunId String   @unique
  agentRun   AgentRun @relation(fields: [agentRunId], references: [id])
}

// oumi
model OumiRun {
  id          String  @id @default(cuid())
  score       Float?
  metrics     Json? // safety score / validity score
  reviewNotes String? // quality review text
  rawOutput   Json?

  createdAt DateTime @default(now())

  agentRunId String   @unique
  agentRun   AgentRun @relation(fields: [agentRunId], references: [id])
}
