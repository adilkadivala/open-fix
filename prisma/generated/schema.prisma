generator client {
  provider = "prisma-client-js"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
}

// user
model User {
  id        String   @id @default(uuid())
  githubId  String   @unique
  name      String?
  email     String?  @unique
  image     String?
  createdAt DateTime @default(now())

  projects  Repos[]
  agentRuns AgentRun[]
}

// Repos
model Repos {
  id          String   @id @default(cuid())
  name        String
  description String?
  repoUrl     String
  repoOwner   String
  repoName    String
  createdAt   DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  issues    Issue[]
  agentRuns AgentRun[]
}

// issues

model Issue {
  id            String  @id @default(cuid())
  githubIssueId Int?    @unique
  title         String
  body          String?
  state         String
  labels        Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projectId String
  project   Repos  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  agentRuns AgentRun[]
}

// agent

model AgentRun {
  id      String @id @default(cuid())
  status  String
  runType String

  issueId String?
  issue   Issue?  @relation(fields: [issueId], references: [id], onDelete: SetNull)

  projectId String
  project   Repos  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  triggeredById String?
  triggeredBy   User?   @relation(fields: [triggeredById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  kestraRun KestraRun?
  clineRun  ClineRun?
}

// kestra
model KestraRun {
  id         String  @id @default(cuid())
  flowId     String?
  flowStatus String?
  summary    String?
  evaluation Json?
  logs       Json?

  createdAt DateTime @default(now())

  agentRunId String   @unique
  agentRun   AgentRun @relation(fields: [agentRunId], references: [id], onDelete: Cascade)
}

// cline
model ClineRun {
  id        String  @id @default(cuid())
  plan      Json?
  output    Json?
  patch     String?
  reasoning String?
  logs      Json?

  createdAt DateTime @default(now())

  agentRunId String   @unique
  agentRun   AgentRun @relation(fields: [agentRunId], references: [id], onDelete: Cascade)
}
